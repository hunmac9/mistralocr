<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Converting - PDF to Markdown</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body>

<div class="container" x-data="jobStatus('{{ job_id }}', '{{ status }}', '{{ download_url or '' }}', '{{ error or '' }}')">
  <h1 class="title">PDF <span class="accent">to</span> Markdown</h1>

  <div class="status-container">
    <div class="status-badge" :class="status">
      <span class="dot"></span>
      <span x-text="statusLabel"></span>
    </div>

    <div class="progress-ring indeterminate" x-show="isProcessing" x-transition>
      <svg width="120" height="120" viewBox="0 0 120 120">
        <circle class="bg" cx="60" cy="60" r="54"/>
        <circle class="fg" cx="60" cy="60" r="54"/>
      </svg>
      <div class="progress-text" x-text="status === 'queued' ? 'Queued' : 'Processing'"></div>
    </div>

    <div x-show="status === 'done'" x-transition>
      <div class="result-box success">
        <a :href="downloadUrl" class="download-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 4v12m0 0l-4-4m4 4l4-4M4 17v2a1 1 0 001 1h14a1 1 0 001-1v-2"/>
          </svg>
          Download ZIP
        </a>
      </div>
    </div>

    <div x-show="status === 'error'" x-transition>
      <div class="result-box error">
        <p class="error-message" x-text="errorMsg"></p>
      </div>
    </div>

    <a href="{{ url_for('index') }}" class="back-link">&larr; Convert another</a>
  </div>
</div>

<script>
function jobStatus(jobId, initialStatus, initialDownloadUrl, initialError) {
  return {
    status: initialStatus,
    downloadUrl: initialDownloadUrl,
    errorMsg: initialError,
    eventSource: null,

    get isProcessing() {
      return this.status === 'queued' || this.status === 'processing';
    },

    get statusLabel() {
      const labels = {
        queued: 'Queued',
        processing: 'Processing',
        done: 'Complete',
        error: 'Error'
      };
      return labels[this.status] || this.status;
    },

    init() {
      if (this.isProcessing) {
        this.connect(jobId);
      }
    },

    connect(jobId) {
      this.eventSource = new EventSource(`/stream/${jobId}`);

      this.eventSource.onmessage = (event) => {
        const data = JSON.parse(event.data);
        this.status = data.status;

        if (data.status === 'done') {
          this.downloadUrl = data.download_url;
          this.eventSource.close();
        } else if (data.status === 'error') {
          this.errorMsg = data.error || 'An error occurred';
          this.eventSource.close();
        }
      };

      this.eventSource.onerror = () => {
        this.status = 'error';
        this.errorMsg = 'Connection lost';
        this.eventSource.close();
      };
    }
  }
}
</script>
</body>
</html>
