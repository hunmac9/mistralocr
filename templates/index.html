<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MistraLOCR</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230c0c0c' width='100' height='100'/><text y='70' x='50' text-anchor='middle' font-size='60' fill='%23c8ff00'>O</text></svg>">
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=5" />
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body>

<div class="app" x-data="uploader()">
  <!-- Full screen grid background -->
  <div class="screen-grid" :class="{ 'active': dragging }"></div>

  <!-- Header -->
  <header class="header">
    <div class="logo">MISTRALOCR</div>
    <div class="backend-toggle">
      <button
        type="button"
        class="toggle-btn"
        :class="{ active: backend === 'surya' }"
        @click="backend = 'surya'"
        {% if not local_ocr_available and not local_ocr_auto_start %}disabled{% endif %}
      >
        <span class="toggle-label">Surya</span>
        <span class="toggle-status {% if local_ocr_available %}on{% elif local_ocr_auto_start %}idle{% else %}off{% endif %}"></span>
      </button>
      <button
        type="button"
        class="toggle-btn"
        :class="{ active: backend === 'paddleocr-vl' }"
        @click="backend = 'paddleocr-vl'"
        {% if not local_ocr_available and not local_ocr_auto_start %}disabled{% endif %}
      >
        <span class="toggle-label">PaddleOCR</span>
        <span class="toggle-status {% if local_ocr_available %}on{% elif local_ocr_auto_start %}idle{% else %}off{% endif %}"></span>
      </button>
      <button
        type="button"
        class="toggle-btn"
        :class="{ active: backend === 'olmocr' }"
        @click="backend = 'olmocr'"
        {% if not local_ocr_available and not local_ocr_auto_start %}disabled{% endif %}
      >
        <span class="toggle-label">OlmOCR</span>
        <span class="toggle-status {% if local_ocr_available %}on{% elif local_ocr_auto_start %}idle{% else %}off{% endif %}"></span>
      </button>
      {% if has_mistral_key %}
      <button
        type="button"
        class="toggle-btn"
        :class="{ active: backend === 'mistral' }"
        @click="backend = 'mistral'"
      >
        <span class="toggle-label">Mistral</span>
        <span class="toggle-status on"></span>
      </button>
      {% endif %}
    </div>
  </header>

  <!-- Main Drop Zone -->
  <main class="main">
    <form action="/process" method="post" enctype="multipart/form-data" @submit="submitting = true">
      <input type="hidden" name="ocr_backend" :value="backend">

      <div
        class="dropzone"
        :class="{ 'drag-over': dragging, 'has-files': files.length }"
        @click="$refs.fileInput.click()"
        @dragenter.prevent="dragging = true"
        @dragover.prevent="dragging = true"
        @dragleave.prevent="dragging = false"
        @drop.prevent="handleDrop($event)"
      >
        <!-- Content -->
        <div class="dropzone-content">
          <template x-if="!files.length">
            <div class="drop-prompt">
              <div class="drop-icon">+</div>
              <div class="drop-text">Drop PDF</div>
            </div>
          </template>

          <template x-if="files.length">
            <div class="file-display">
              <div class="file-count" x-text="files.length"></div>
              <div class="file-label" x-text="files.length === 1 ? 'file' : 'files'"></div>
              <div class="file-list">
                <template x-for="(file, i) in files" :key="i">
                  <div class="file-item" @click.stop="removeFile(i)">
                    <span x-text="file.name"></span>
                    <span class="remove">&times;</span>
                  </div>
                </template>
              </div>
            </div>
          </template>
        </div>

        <input
          type="file"
          name="pdf_files"
          x-ref="fileInput"
          accept=".pdf"
          multiple
          required
          @change="handleFiles($event.target.files)"
        >
      </div>

      <!-- Convert Button -->
      <button
        type="submit"
        class="convert-btn"
        x-show="files.length"
        x-transition:enter="fade-in"
        :disabled="submitting"
        :class="{ loading: submitting }"
      >
        <span class="btn-text">Convert</span>
        <span class="btn-spinner"></span>
      </button>
    </form>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <span class="limit">{{ max_upload_mb }}MB max</span>
  </footer>
</div>

<script>
function uploader() {
  return {
    files: [],
    dragging: false,
    submitting: false,
    backend: '{% if ocr_backend == "mistral" %}mistral{% elif ocr_backend == "paddleocr-vl" %}paddleocr-vl{% else %}surya{% endif %}',

    handleFiles(fileList) {
      this.files = [...fileList].filter(f => f.type === 'application/pdf');
      this.syncInput();
    },

    handleDrop(e) {
      this.dragging = false;
      const dropped = [...e.dataTransfer.files].filter(f => f.type === 'application/pdf');
      if (dropped.length) {
        this.files = [...this.files, ...dropped];
        this.syncInput();
      }
    },

    removeFile(index) {
      this.files.splice(index, 1);
      this.syncInput();
    },

    syncInput() {
      const dt = new DataTransfer();
      this.files.forEach(f => dt.items.add(f));
      this.$refs.fileInput.files = dt.files;
    }
  }
}
</script>
</body>
</html>
