services:
  # Main application service
  app:
    build: .
    # Read port from .env file, default to 5009 if not set
    ports:
      - "${FLASK_PORT:-5009}:${FLASK_PORT:-5009}"
    environment:
      # Optional: Mistral API Key (only needed if using Mistral backend)
      MISTRAL_API_KEY: ${MISTRAL_API_KEY:-}

      # Optional: Port (loaded from .env, defaults here match port mapping)
      FLASK_PORT: ${FLASK_PORT:-5009}

      # Optional: Max upload sizes (loaded from .env)
      MAX_UPLOAD_MB: ${MAX_UPLOAD_MB:-100}
      MISTRAL_MAX_MB: ${MISTRAL_MAX_MB:-50}

      # Optional: Server Name for external URLs (loaded from .env)
      # Defaults to localhost:{FLASK_PORT} if SERVER_NAME is not set in .env
      SERVER_NAME: ${SERVER_NAME:-localhost:${FLASK_PORT:-5009}}

      # Optional: Flask Debug Mode (loaded from .env)
      FLASK_DEBUG: ${FLASK_DEBUG:-False}

      # --- OCR Backend Configuration ---
      # OCR_BACKEND: "auto" (default), "local", or "mistral"
      OCR_BACKEND: ${OCR_BACKEND:-auto}

      # Local OCR service URL (use Docker service name)
      LOCAL_OCR_URL: http://local-ocr:8000

      # Local OCR settings
      LOCAL_OCR_IDLE_TIMEOUT: ${LOCAL_OCR_IDLE_TIMEOUT:-300}
      LOCAL_OCR_AUTO_START: "false"  # Container managed by compose, not auto-started
      LOCAL_OCR_MODELS: "surya"  # CPU mode only supports Surya

    depends_on:
      local-ocr:
        condition: service_healthy
    networks:
      - ocr-network

    # Override the default CMD:
    # Note: CPU OCR is slow (~2 min/page), so we need a long timeout
    command: ["gunicorn", "--bind", "0.0.0.0:${FLASK_PORT:-5009}", "--timeout", "600", "app:app"]

  # Local OCR service - Surya OCR only (CPU mode)
  local-ocr:
    build:
      context: ./local_ocr
      dockerfile: Dockerfile
    environment:
      # Idle timeout in seconds (model unloads after this period of inactivity)
      IDLE_TIMEOUT: ${LOCAL_OCR_IDLE_TIMEOUT:-300}
      OCR_BACKEND: surya  # CPU mode only supports Surya
      PORT: 8000
      HOST: 0.0.0.0
    volumes:
      # Persist model cache to avoid re-downloading
      - ocr-model-cache:/home/appuser/.cache
    networks:
      - ocr-network
    # Resource limits for CPU-only deployment
    deploy:
      resources:
        limits:
          memory: 8G  # Limit memory usage
        reservations:
          memory: 4G  # Reserve minimum memory
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s  # Allow time for initial model download

networks:
  ocr-network:
    driver: bridge

volumes:
  # Named volume for persistent model cache
  ocr-model-cache:
