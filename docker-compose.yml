services:
  app:
    build: .
    # Read port from .env file, default to 5009 if not set
    ports:
      - "${FLASK_PORT:-5009}:${FLASK_PORT:-5009}"
    environment:
      # Required: API Key (loaded from .env)
      MISTRAL_API_KEY: ${MISTRAL_API_KEY}

      # Optional: Port (loaded from .env, defaults here match port mapping)
      FLASK_PORT: ${FLASK_PORT:-5009}

      # Optional: Max upload sizes (loaded from .env)
      MAX_UPLOAD_MB: ${MAX_UPLOAD_MB:-100}
      MISTRAL_MAX_MB: ${MISTRAL_MAX_MB:-50}

      # Optional: Server Name for external URLs (loaded from .env)
      # Defaults to localhost:{FLASK_PORT} if SERVER_NAME is not set in .env
      SERVER_NAME: ${SERVER_NAME:-localhost:${FLASK_PORT:-5009}}

      # Optional: Flask Debug Mode (loaded from .env)
      FLASK_DEBUG: ${FLASK_DEBUG:-False}

      # Optional: Override default upload/output folders (relative to /app)
      # UPLOAD_FOLDER: ${UPLOAD_FOLDER:-uploads}
      # OUTPUT_FOLDER: ${OUTPUT_FOLDER:-output}

    # Optional volumes for persisting data outside the container
    # volumes:
      # - ./uploads:/app/uploads # Persist uploaded files (app currently cleans this up, maybe remove?)
      # - ./output:/app/output   # Persist generated output files

    # Override the default CMD:
    # - Bind Gunicorn to the port specified by FLASK_PORT (defaulting to 5009)
    # - Increase the worker timeout to 300 seconds (5 minutes)
    command: ["gunicorn", "--bind", "0.0.0.0:${FLASK_PORT:-5009}", "--timeout", "300", "app:app"]
